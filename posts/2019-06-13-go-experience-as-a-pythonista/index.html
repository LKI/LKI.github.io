<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.59.1" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="Lirian Su" />
  <meta property="og:url" content="https://liriansu.com/posts/2019-06-13-go-experience-as-a-pythonista/" />
  <link rel="canonical" href="https://liriansu.com/posts/2019-06-13-go-experience-as-a-pythonista/" /><script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https:\/\/liriansu.com\/"
      },
      "articleSection" : "posts",
      "name" : "Pythonista 的 Go 之旅",
      "headline" : "Pythonista 的 Go 之旅",
      "description" : "背景 我们团队后端主要技术栈是 Python, 具体的软工实践在前文 django\/python 里有详细的介绍。 由于平时做公司业务主要写的是 Python, 自己做的项目也是 Python 工具， 所以其实一直想尝试体验一下 Go。\n正好上周有空， 于是体验了一下 Go 的基础设定， 用 Go 写了一个小服务（微信消息推送）。\n这篇文章讲的就是一个 Pythonista 的 Go 萌新之路。 有理解谬误、操作不当的地方， 请各位多指教了。\n语法 上手一个语言， 总是习惯性打开 learn x in y minutes 先过一遍语法。\nGo 的特别之处是它的关键字非常少， 这让 Go 的语法很容易被记下来。 总的来说我觉得这几个语法很好玩。\n循环 \/\/ 直接 for 就可以写死循环 for { fmt.Println(\x26quot;while true...\x26quot;) } \/\/ range 这个关键词用起来很舒服 data := map[string]string{ \x26quot;key\x26quot;: \x26quot;value\x26quot;, } for key, value := range data { fmt.",
      "inLanguage" : "en-US",
      "author" : "Lirian Su",
      "creator" : "Lirian Su",
      "publisher": "Lirian Su",
      "accountablePerson" : "Lirian Su",
      "copyrightHolder" : "Lirian Su",
      "copyrightYear" : "2019",
      "datePublished": "2019-06-13 01:10:49 \x2b0000 UTC",
      "dateModified" : "2019-06-13 01:10:49 \x2b0000 UTC",
      "url" : "https:\/\/liriansu.com\/posts\/2019-06-13-go-experience-as-a-pythonista\/",
      "keywords" : [  ]
  }
</script>
<title>Pythonista 的 Go 之旅 - 浮云计算</title>
  <meta property="og:title" content="Pythonista 的 Go 之旅 - 浮云计算" />
  <meta property="og:type" content="article" />
  <meta name="description" content="背景 我们团队后端主要技术栈是 Python, 具体的软工实践在前文 django/python 里有详细的介绍。 由于平时做公司业务主要写的是 Python, 自己做的项目也是 Python 工具， 所以其实一直想尝试体验一下 Go。
正好上周有空， 于是体验了一下 Go 的基础设定， 用 Go 写了一个小服务（微信消息推送）。
这篇文章讲的就是一个 Pythonista 的 Go 萌新之路。 有理解谬误、操作不当的地方， 请各位多指教了。
语法 上手一个语言， 总是习惯性打开 learn x in y minutes 先过一遍语法。
Go 的特别之处是它的关键字非常少， 这让 Go 的语法很容易被记下来。 总的来说我觉得这几个语法很好玩。
循环 // 直接 for 就可以写死循环 for { fmt.Println(&quot;while true...&quot;) } // range 这个关键词用起来很舒服 data := map[string]string{ &quot;key&quot;: &quot;value&quot;, } for key, value := range data { fmt." />

  <link rel="stylesheet" href="/css/flexboxgrid-6.3.1.min.css" />
  <link rel="stylesheet"
    href="/css/github-markdown.min.css" />
  <link rel="stylesheet" href="/css/highlight/tomorrow.min.css" />
  <link rel="stylesheet" href="/css/index.css">
  <link href="/index.xml" rel="alternate" type="application/rss+xml" title="浮云计算">
  
  <link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker" rel="stylesheet">
  
  

  
</head>


<body>
  <article class="post 中文" id="article">
    <div class="row">
      <div class="col-xs-12 col-sm-10 col-md-8 col-sm-offset-1 col-md-offset-2 col-lg-6 col-lg-offset-3">
        <div class="site-header">
          
<header>
  <div class="signatures site-title">
    <a href="/">Lirian Su</a>
  </div>
</header>
<div class="row end-xs">
  
  
  <div class="lang-switch col-xs-3 col-xs-offset-9">
    <a href="/en/">English</a>
  </div>
  
  
</div>
<div class="header-line"></div>

        </div>
        <header class="post-header">
          <h1 class="post-title">Pythonista 的 Go 之旅</h1>
          
          <div class="row post-desc">
            <div class="col-xs-6">
              
              <time class="post-date" datetime="2019-06-13 01:10:49 UTC">
                2019-06-13
              </time>
              
            </div>
            <div class="col-xs-6">
              
              <div class="post-author">
                <a target="_blank" href="">@Lirian Su</a>
              </div>
              
            </div>
          </div>
          
        </header>

        <div class="post-content markdown-body">
          

<!--MORE-->

<h1 id="背景">背景</h1>

<p>我们团队后端主要技术栈是 Python,
具体的软工实践在前文 <a href="/software-engineering-django">django/python</a> 里有详细的介绍。
由于平时做公司业务主要写的是 Python,
自己做的项目也是 Python 工具，
所以其实一直想尝试体验一下 Go。</p>

<p>正好上周有空，
于是体验了一下 Go 的基础设定，
用 Go 写了一个小服务（微信消息推送）。</p>

<p>这篇文章讲的就是一个 Pythonista 的 Go 萌新之路。
有理解谬误、操作不当的地方，
请各位多指教了。</p>

<h1 id="语法">语法</h1>

<p>上手一个语言，
总是习惯性打开 <a href="https://learnxinyminutes.com/docs/go/">learn x in y minutes</a> 先过一遍语法。</p>

<p><img src="/slides/golang-experience/reserved_words.png" alt="go keyword" /></p>

<p>Go 的特别之处是它的关键字非常少，
这让 Go 的语法很容易被记下来。
总的来说我觉得这几个语法很好玩。</p>

<h2 id="循环">循环</h2>

<pre><code class="language-go">// 直接 for 就可以写死循环
for {
    fmt.Println(&quot;while true...&quot;)     
}

// range 这个关键词用起来很舒服
data := map[string]string{
    &quot;key&quot;: &quot;value&quot;,
}
for key, value := range data {       
    fmt.Println(&quot;while true...&quot;)     
}
</code></pre>

<h2 id="枚举">枚举</h2>

<pre><code class="language-go">// iota 居然被做成了关键字
// 这里后面的俩 iota 是可以省略的
const {
    Unknown = iota  // 0
    Male    = iota  // 1
    Female  = iota  // 2
}

// 也可以满足隔 10 定义枚举的喜好
// `iota &lt;&lt; 2` 这样位运算定义 1/2/4/8 也是可以的
const {
    Unknown = iota * 10  // 0
    Male    = iota * 10  // 10
    Female  = iota * 10  // 20
}
</code></pre>

<h2 id="多表达式判断">多表达式判断</h2>

<pre><code class="language-go">// if 语句会取最后的表达式值，所以这么判断是很常见的
if f, err := file.Open(path); err != nil {
    return Response(400, err.Error())
}

// 这样判断布尔值也是常见的操作
if data, ok := json.Unmarshal(body); !ok {
    return Response(400, &quot;invalid json body&quot;)
}
</code></pre>

<h2 id="goroutine">goroutine</h2>

<pre><code class="language-go">// go 的天生并发也是非常优雅的地方
func sendTemplate() {
    // 这里是耗时很久的网络请求
}

func handleRequest(ctx Context) {
    validate()
    // sendTemplate()
    // ↑ 假如为了速度，我们不能同步发送模板，那么我们用 `go` 这个关键字就可以一键异步 ↓
    go sendTemplate()
}
</code></pre>

<h1 id="项目">项目</h1>

<p>第一章的语法过了以后，
很快就到了第二章：
《如何用 go 起一个项目》</p>

<p>要写代码，首先就得把文档给翻出来看看。
于是第一站便是<a href="https://golang.org/">官网 golang.org</a></p>

<p>Go 的官网其实非常友好，
从最基础的<a href="https://golang.org/doc/code.html">教你怎么配环境、写初始的项目</a>，
到 <a href="https://golang.org/doc/effective_go.html">Effective Go</a> 这种全面长文都浅显到点。</p>

<p>上手装好语言环境以后，
首先跟 <code>GOPATH</code> 这个环境变量玩了一下。
不过后来发现 Go 1.12 以后自带 go mod,
只要简单了解一下这个概念就行了。
那我们先放一下，
直接上手感受 Go 的工具链吧。</p>

<h2 id="工具链">工具链</h2>

<p>Python 装好以后主要自带的是个 REPL 跟 pip 这个包管理器。
Go 装好以后，会自带包括 fmt/test/vet/mod 等一系列的工具。</p>

<ul>
<li><code>go fmt</code>

<ul>
<li>这个是上手 Go 第一印象最大的工具</li>
<li>它是一个不支持配置的代码格式化工具，非常严格</li>
<li><del>prefer tab over space</del></li>
</ul></li>
<li><code>go test</code>

<ul>
<li>自带 coverage, 很好用</li>
</ul></li>
<li><code>go vet</code>

<ul>
<li>似乎是自带的 linter</li>
</ul></li>
</ul>

<p>玩 <code>go test</code> 的时候发现它是针对 <code>package</code> 来做测试的，
而 Go 里面，
<code>package</code> 的概念也是非常突出。
比如调用包方法的时候是要加包名的，
所以最佳实践里也有“命名不重叠”的规则。
（举个栗子，比如方法应该叫 <code>xml.Parser</code> 而不是 <code>xml.XMLParser</code>）</p>

<h2 id="写业务">写业务</h2>

<p>由于我们写的是一个对内网以 RESTful 风格提供接口，
然后调用微信发送消息通知用户的这么一个小服务，
按照 Python 的惯性就想找个 <code>django</code> + <code>wechatpy</code> 的组合在一周内来完成业务。
简单调研了一圈，选了 <code>gin</code> + <code>gorm</code> 两个大的工具。</p>

<p>Go 的第三方库给我的感觉是非常直白。
因为引入第三方库的方式是 <code>go get -u github.com/gin-gonic/gin</code>，
直接拉的就是 GitHub master 分支的最新代码，
所以感觉整个第三方的社区是基于分布式共识的，
只有大家都遵守社区规范，
才不会有挖矿代码的出现…（虽然中心化也会有挖矿代码）</p>

<p>文档的话，调研阶段读的其实都是 GitHub README，
GitHub 是经常逛的网站，
各个库的 README 风格也都是 markdown 风格，
读起来也很轻松。
真正要看 godoc 的地方不多。
因为拉的是源代码，
所以基本上都是直接读源代码，
体验跟 Python 非常像。</p>

<p>具体业务代码就先略过了，
没有什么特别的。</p>

<h2 id="部署">部署</h2>

<p>开始准备部署的时候又有不少好玩的话题。
比如 Go 的多环境配置。</p>

<p>Python (Django) 的多环境我一直用的是环境变量 + 多配置文件，
Go 的话去看了一下社区，
基本也是类似的原理。
可以用环境变量，
也可以用多配置文件（比如 yaml），
还有一个就是用命令参数（flag 库）。
Go 社区里其实比较推崇用 flag，
因为这样可以把配置跟代码（执行文件）融为一体，
更加利于维护。
不过我最终还是选择了环境变量 + 多配置文件…</p>

<p>项目的编译、部署我们用的是 GitLab CI/Docker。
也是 ci-build/test/compile/docker-build/deploy 五个套路阶段。
Go 里比较特别的是会大量引用 GitHub 以及 Google 官方提供的代码，
在国内拉的速度比较慢，
所以为了加速构建，
我们也自己搭了相应的加速通道去提升速度。
目前来说，从代码进主干分支，
到自动发版大概耗时不超过 3min。</p>

<h2 id="性能">性能</h2>

<p>自己写的小服务上去了，
那首先就要 wrk 一下测一下 QPS 啦。</p>

<p>Python(Django) 默认的其实是同步模式，
基础支持的 QPS 很低，
我们用 gevent + uwsgi 协程模式特意调优过，
一个获取服务器当前时间的简单接口，
在 1CPU+4G Memory 的小破机器上，
Python(gevent) 的 QPS 大概能到 1000，
而未经调优的 Go(gin) QPS 能到 10000。
真有你的啊，Go。</p>

<h2 id="社区">社区</h2>

<p>在玩 Go 的一周中，
其实我真正的有效编码时间不是很长，
大部分时间都徜徉在 Go 的各种社区最佳实践文档里。</p>

<p>在我眼中，
除去 Go 语言本身的很多闪光点，
Go 的整个语言社区运营也是值得其他语言学习的。
比如上面讲到的官方推的工具链，
这能有效提升所有项目的下限。
Python 去年也刚出了<a href="https://github.com/python/black">一个格式化工具 black</a>，
自己宣称是 <strong>the uncompromising code formatter</strong>。
（Python: 别催，在学了在学了）</p>

<h1 id="感受">感受</h1>

<p>讲了这么多看似中立，
实际都是感受的发言，
我来集中总结一下我的感受。</p>

<h2 id="我很菜">我很菜</h2>

<p>写 Go 的时候我是能直白地感受到自己很菜的。
一块是很多地方我能感知到有语法简化的可能性，
但我的语言表达能力还没达到优化的水瓶。
比如 <a href="https://go.googlesource.com/proposal/+/master/design/go2draft-error-handling-overview.md">Go 2 Draft 里的 check 关键字</a>，
我隐约感觉好像基于 <code>panic + recover</code> 也能实现类似的机制，
但真要写又写不出。
而 Python 我就感觉能完全写成 Lisp。</p>

<p>另一块是库的使用，或者叫“语言生态”。
不论是平时用到的标准库，
还是后端业务要用的各类三方库，
或是工程化用到的单元测试、质量把控的库，
我都只能在用到的时候做现场调研。</p>

<p>总之因为基础知识缺乏，
加上熟练度不够，
写 Go 的过程就总有一种“我好菜啊，这个都不懂”的奇妙感觉。</p>

<h2 id="我喜欢-go">我喜欢 Go</h2>

<p>菜并没阻止我表达喜欢 :)</p>

<p>Go 身上透露出了非常老派的 KISS 原则，
它甚至很多时候给我的感觉是比 Python 还要简约。
比如最佳实践会跟你说：
“不要过早拆文件，
一个目录十个文件能解决的问题不需要分层。”</p>

<p>相比 Python 而言，
Go 的执行速度透露着一种不讲道理的快。
Python 深入了解并发模型，
调优 CPU 跟语言参数以后的结果，
还是跟 Go 差了一个量级…
（不过开发速度上 Python 还是巨快…）</p>

<p>而且，
Go 还有可爱的 <a href="https://github.com/egonelbre/gophers">Gopher</a> 呀~</p>

<p><img src="https://github.com/egonelbre/gophers/raw/master/.thumb/icon/emoji-3x.png" alt="gopher-emoji" /></p>

<h2 id="go-的实践">Go 的实践</h2>

<p>目前我司后端的主技术栈是 Java 跟 Python，
我主要写的是 Python。</p>

<p>以我短暂的体验而言，
Go 在关键的高性能服务上会有很好的表现，
但在新业务的原型、Web 层的多业务上，
Python 魔法般的开发速度还是无人能比的（叉腰）</p>

<p>目前后端的各种流行框架基本都是语言无关的，
我们可以根据不同业务的适用场景来选择合适的技术栈。</p>

<p>企业在选择技术栈中，
其实也会考虑其它更现实的因素，
比如开发人员的招聘难度，
代码库、技术栈的统一，
大型团队的解耦管理。
这些其实也都是非常有深度的、值得探讨的话题。</p>

<p>写了一周 Go,
我更坚信自己的理念了：
“工程师是解决问题的人，
技术是解决问题的工具。
软件工程没做好说工具难用，
是何异于：
刺人而杀之曰，非我也，兵也？”</p>

<h1 id="后续">后续</h1>

<p>一周的体验卡有点太短了，
非常意犹未尽。</p>

<p>后续有时间的话，
关于 Go 的这些话题我会继续研究：</p>

<ul>
<li>产线环境上的服务部署姿势。</li>
<li>Go 的服务可视化（监控、日志、追踪）</li>
<li>用黑魔法让语言表达力更高的基础库</li>
<li>跨语言服务间的交互实践</li>
</ul>

<p>欢迎交流，
也对文章里的不当之处作出指正批评。</p>

<p>（完）</p>

        </div>
        

        


        
        
        <div style="height: 50px;"></div>
        
        <div class="post-comments">
          <script src="https://utteranc.es/client.js"
                  repo="LKI/lki.github.io"
                  issue-term="title"
                  label="comment"
                  theme="github-light"
                  crossorigin="anonymous"
                  async>
          </script>
        </div>

        <div class="site-footer">
  
  <div class="site-footer-item">
    <a href="/about" target="_blank">about</a>
  </div>
  
  <div class="site-footer-item">
    <a href="https://github.com/LKI/LKI" target="_blank">github</a>
  </div>
  
  <div class="site-footer-item">
    <a href="/index.xml" target="_blank">rss</a>
  </div>
  
  <div class="site-footer-item">
    <span id="busuanzi_container_site_pv"> PV: <span id="busuanzi_value_site_pv"> </span> </span>
  </div>
  <div class="site-footer-item">
    <span id="busuanzi_container_site_uv"> UV: <span id="busuanzi_value_site_uv"/> </span> </span>
  </div>
</div>

      </div>
    </div>
  </article>

  <script src="/js/highlight.pack.js"></script>


<script>
  hljs.initHighlightingOnLoad();

  
  
    
    
  
</script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  

</body>

</html>
